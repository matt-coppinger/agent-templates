# Data Ingester Sub-Agent Output Spec
# Produces normalised, structured financial data from raw input

schema:
  report_id:
    type: string
    required: true
    description: Unique identifier for this analysis run

  timestamp:
    type: datetime
    required: true
    description: ISO 8601 timestamp of ingestion

  report_type:
    type: enum
    required: true
    values: [monthly-variance, quarterly-forecast, annual-budget-review]
    description: Type of report being generated

  reporting_period:
    type: object
    required: true
    fields:
      period_type: { type: enum, values: [month, quarter, year] }
      period_label: { type: string, description: "e.g. 'January 2026', 'Q1 2026', 'FY 2025'" }
      start_date: { type: date }
      end_date: { type: date }

  currency:
    type: string
    required: true
    description: ISO 4217 currency code (e.g. GBP)

  data_columns:
    type: list
    required: true
    items:
      type: object
      fields:
        column_type:
          type: enum
          values: [actuals, budget, prior_year, prior_month, forecast, ytd_actuals, ytd_budget]
        period_label: { type: string }
    description: What each data column represents

  line_items:
    type: list
    required: true
    items:
      type: object
      fields:
        canonical_name:
          type: string
          required: true
          description: Standardised name from config KPI list
        original_label:
          type: string
          required: true
          description: Label as it appeared in the raw data
        line_type:
          type: enum
          required: true
          values: [revenue, cost, subtotal, margin, ratio, headcount, other]
        values:
          type: object
          required: true
          description: "Key-value pairs matching data_columns (e.g. actuals: 150000)"
        is_calculated:
          type: boolean
          required: true
          description: Whether this value was calculated by the ingester or read from input
        unit:
          type: enum
          values: [currency, percentage, count, ratio]
          required: true

  kpis:
    type: object
    required: true
    description: Extracted KPIs with values per data column
    fields:
      primary:
        type: list
        items:
          type: object
          fields:
            name: { type: string }
            values: { type: object }
            available: { type: boolean }
      secondary:
        type: list
        items:
          type: object
          fields:
            name: { type: string }
            values: { type: object }
            available: { type: boolean }

  data_quality:
    type: object
    required: true
    fields:
      score:
        type: float
        min: 0.0
        max: 1.0
        description: Overall data quality score
      completeness:
        type: float
        description: Proportion of expected fields present
      consistency:
        type: float
        description: Do subtotals reconcile? Do margins compute correctly?
      issues:
        type: list
        items:
          type: object
          fields:
            severity: { type: enum, values: [error, warning, info] }
            description: { type: string }
            affected_items: { type: list, items: { type: string } }

  parsing_assumptions:
    type: list
    required: false
    items:
      type: string
    description: Any assumptions made during parsing (e.g. "amounts assumed in thousands")

example:
  report_id: "RPT-2026-01"
  timestamp: "2026-02-15T10:00:00Z"
  report_type: monthly-variance
  reporting_period:
    period_type: month
    period_label: "January 2026"
    start_date: "2026-01-01"
    end_date: "2026-01-31"
  currency: GBP
  data_columns:
    - column_type: actuals
      period_label: "Jan 2026"
    - column_type: budget
      period_label: "Jan 2026 Budget"
    - column_type: prior_year
      period_label: "Jan 2025"
  line_items:
    - canonical_name: revenue
      original_label: "Net Revenue"
      line_type: revenue
      values: { actuals: 1250000, budget: 1200000, prior_year: 1100000 }
      is_calculated: false
      unit: currency
  kpis:
    primary:
      - name: revenue
        values: { actuals: 1250000, budget: 1200000, prior_year: 1100000 }
        available: true
      - name: gross_margin_pct
        values: { actuals: 62.4, budget: 60.0, prior_year: 58.5 }
        available: true
    secondary:
      - name: revenue_per_head
        values: {}
        available: false
  data_quality:
    score: 0.88
    completeness: 0.92
    consistency: 0.85
    issues:
      - severity: warning
        description: "Headcount data not provided â€” revenue per head cannot be calculated"
        affected_items: ["headcount", "revenue_per_head"]
  parsing_assumptions:
    - "All amounts in whole pounds (not thousands)"
